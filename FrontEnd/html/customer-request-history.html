<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Request History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="../styles/customer-dashboard.css" />
    <style>
        .section-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: #0d3b66;
        }
        table th, table td { vertical-align: middle; }
        .btn-edit { color: #0d6efd; cursor: pointer; }
        .btn-delete { color: #dc3545; cursor: pointer; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">My Dashboard</a>
        <div class="d-flex align-items-center">
            <a href="../index.html" class="text-white fs-5 me-3" title="Home">
                <i class="bi bi-house-door"></i>
            </a>
            <div class="me-3 text-white fw-bold" id="profileName">Name</div>
        </div>
    </div>
</nav>

<section class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center mb-4 section-title">My Service Request History</h2>
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-bordered table-hover bg-white">
                <thead class="table-primary">
                <tr>
                    <th>#</th>
                    <th>Ship Name</th>
                    <th>Port</th>
                    <th>Services</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="requestTableBody">
                <tr>
                    <td colspan="7" class="text-center text-muted">Loading...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- Edit Modal -->
<div class="modal fade" id="editRequestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRequestForm">
                    <input type="hidden" id="editRequestId">
                    <div class="mb-3">
                        <label class="form-label">Ship Name</label>
                        <input type="text" class="form-control" id="editShipName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Port</label>
                        <select class="form-select" id="editPort"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Services</label>
                        <select class="form-select" id="editServices" multiple></select>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Request</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function () {
        const username = localStorage.getItem("username") || "Name";
        const userId = localStorage.getItem("userId");
        $("#profileName").text(username);

        const $requestTableBody = $("#requestTableBody");
        let requests = [];

        // ------------------ Load Requests ------------------
        function loadRequests() {
            $.ajax({
                url: `http://localhost:8080/api/v1/requestServices/getAllRequestsByUser/${userId}`,
                type: "GET",
                success: function (res) {
                    requests = Array.isArray(res) ? res : res.data || [];
                    renderRequests();
                },
                error: function () {
                    $requestTableBody.html(
                        '<tr><td colspan="7" class="text-center text-danger">Error loading data.</td></tr>'
                    );
                }
            });
        }

        function renderRequests() {
            if (!requests.length) {
                $requestTableBody.html(
                    '<tr><td colspan="7" class="text-center text-muted">No requests found.</td></tr>'
                );
                return;
            }

            let rows = "";
            requests.forEach((req, index) => {
                const serviceNames = req.serviceNames?.join(", ") || "No Services";
                const portName = req.portName || "N/A";

                rows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${req.shipName}</td>
                        <td>${portName}</td>
                        <td>${serviceNames}</td>
                        <td>${req.description || ""}</td>
                        <td>${req.status}</td>
                        <td>
                            <i class="bi bi-pencil-square btn-edit me-2" data-id="${req.id}" title="Edit"></i>
                            <i class="bi bi-trash btn-delete text-danger" data-id="${req.id}" title="Delete"></i>
                        </td>
                    </tr>
                `;
            });

            $requestTableBody.html(rows);
        }
        //load ports
        function loadPorts(callback) {
            $.get("http://localhost:8080/api/v1/port/getAllPorts", function (res) {
                console.log("Ports API Response:", res);
                const ports = Array.isArray(res) ? res : res.data;
                const $editPort = $("#editPort");
                $editPort.empty();
                if (!ports || ports.length === 0) {
                    $editPort.append('<option disabled>No Ports Found</option>');
                } else {
                    ports.forEach(port => {
                        $editPort.append(`<option value="${port.id}">${port.portName}</option>`);
                    });
                }
                if (callback) callback();
            }).fail(function () {
                alert("Failed to load ports.");
            });
        }

        //load services
        function loadServices(callback) {
            $.get("http://localhost:8080/api/v1/service/getAllServices", function (res) {
                console.log("Services API Response:", res);
                const services = Array.isArray(res) ? res : res.data;
                const $editServices = $("#editServices");
                $editServices.empty();
                if (!services || services.length === 0) {
                    $editServices.append('<option disabled>No Services Found</option>');
                } else {
                    services.forEach(service => {
                        $editServices.append(`<option value="${service.id}">${service.serviceName}</option>`);
                    });
                }
                if (callback) callback();
            }).fail(function () {
                alert("Failed to load services.");
            });
        }

        // ------------------ Edit Request ------------------
        $(document).on("click", ".btn-edit", function () {
            const requestId = $(this).data("id");
            const req = requests.find(r => r.id == requestId);
            if (!req) return;

            loadPorts(function () {
                loadServices(function () {
                    $("#editRequestId").val(req.id);
                    $("#editShipName").val(req.shipName);
                    $("#editDescription").val(req.description || "");
                    $("#editPort").val(req.portId || "");
                    $("#editServices").val(req.serviceIds?.map(String) || []);

                    // Show modal after dropdowns are ready
                    new bootstrap.Modal(document.getElementById("editRequestModal")).show();
                });
            });
        });

        // ------------------ Update Request ------------------
        $("#editRequestForm").submit(function (e) {
            e.preventDefault();
            const requestData = {
                id: $("#editRequestId").val(),
                shipName: $("#editShipName").val(),
                description: $("#editDescription").val(),
                portId: $("#editPort").val(),
                serviceIds: $("#editServices").val()
            };

            $.ajax({
                url: "http://localhost:8080/api/v1/requestServices/updateRequest",
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(requestData),
                success: function () {
                    alert("Request updated successfully!");
                    $("#editRequestModal").modal("hide");
                    loadRequests();
                },
                error: function () {
                    alert("Failed to update the request.");
                }
            });
        });

        // ------------------ Delete Request ------------------
        $(document).on("click", ".btn-delete", function () {
            const requestId = $(this).data("id");
            if (!confirm("Are you sure you want to delete this request?")) return;

            $.ajax({
                url: `http://localhost:8080/api/v1/requestServices/delete/${requestId}`,
                type: "DELETE",
                success: function () {
                    alert("Request deleted successfully!");
                    loadRequests();
                },
                error: function () {
                    alert("Failed to delete the request.");
                }
            });
        });

        // Initial load
        loadRequests();
    });
</script>


</body>
</html>
